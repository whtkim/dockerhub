#!/bin/bash

# å®‰è£… PHP Redis æ‰©å±•
buildRedis() {
  REDIS_VERSION="$1"

  echo -e "\nğŸ”§ Building Redis extension: v${REDIS_VERSION}\n"

  # ä¸‹è½½ Redis æ‰©å±•æºç åŒ…
  curl -fsSL -o /tmp/redis-${REDIS_VERSION}.tgz "https://pecl.php.net/get/redis-${REDIS_VERSION}.tgz"

  # è§£å‹æºç 
  tar -xzf /tmp/redis-${REDIS_VERSION}.tgz -C /tmp
  cd /tmp/redis-${REDIS_VERSION}

  # æ„å»ºå¹¶å®‰è£…æ‰©å±•
  phpize
  ./configure
  make -j"$(nproc)"
  make install

  # å¯ç”¨æ‰©å±•
  echo "extension=redis.so" >> "${PHP_ROOTDIR}/conf.d/extension.ini"

  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  rm -rf /tmp/*
  echo -e "\nâœ… Redis v${REDIS_VERSION} build complete.\n"
}

# å®‰è£… PHP Swoole æ‰©å±•
buildSwoole() {
  SWOOLE_VERSION="$1"

  set -e  # é‡åˆ°é”™è¯¯å³é€€å‡º

  echo -e "\nğŸ”§ Building Swoole extension: v${SWOOLE_VERSION}\n"

  SRC_URL="https://github.com/swoole/swoole-src/archive/refs/tags/v${SWOOLE_VERSION}.tar.gz"
  SRC_TGZ="/tmp/swoole-src-${SWOOLE_VERSION}.tgz"
  SRC_DIR="/tmp/swoole-src-${SWOOLE_VERSION}"

  echo "ğŸ“¥ Downloading Swoole source..."
  curl -fsSL -o "$SRC_TGZ" "$SRC_URL"

  echo "ğŸ“¦ Extracting..."
  tar -xzf "$SRC_TGZ" -C /tmp

  echo "ğŸš§ Building..."
  cd "$SRC_DIR"
  phpize
  ./configure --enable-sockets --enable-openssl --enable-http2 --enable-mysqlnd --enable-swoole-json --enable-swoole-curl
  make -j"$(nproc)"
  make install

  echo "ğŸ“¦ Enabling Swoole extension..."
  echo "extension=swoole.so" >> "${PHP_ROOTDIR}/conf.d/extension.ini"

  echo "ğŸ§¹ Cleaning up..."
  rm -rf "$SRC_TGZ" "$SRC_DIR"

  echo -e "\nâœ… Swoole v${SWOOLE_VERSION} build complete.\n"
}

# å®‰è£… PHP Imagick æ‰©å±•
buildImagick() {
  IMAGEMAGICK_VERSION="$1"
  IMAGICK_VERSION="$2"

  echo -e "\nğŸ”§ Building Imagick extension: v${IMAGEMAGICK_VERSION}\n"

  # ä¸‹è½½å¹¶ç¼–è¯‘ ImageMagickï¼ˆç³»ç»Ÿåº“ï¼‰
  echo "ğŸ“¥ Downloading ImageMagick..."
  curl -fsSL -o /tmp/ImageMagick-${IMAGEMAGICK_VERSION}.tar.gz \
    "https://github.com/ImageMagick/ImageMagick/archive/refs/tags/${IMAGEMAGICK_VERSION}.tar.gz"

  echo "ğŸ“¦ Extracting ImageMagick..."
  tar -xzf /tmp/ImageMagick-${IMAGEMAGICK_VERSION}.tar.gz -C /tmp
  cd /tmp/ImageMagick-${IMAGEMAGICK_VERSION}
  ./configure --prefix=/usr/local/imagick
  make -j"$(nproc)"
  make install

  # ä¸‹è½½å¹¶å®‰è£… imagick PHP æ‰©å±•
  echo "ğŸ“¥ Downloading imagick PHP extension..."
  curl -fsSL -o /tmp/imagick-${IMAGICK_VERSION}.tgz \
    "https://pecl.php.net/get/imagick-${IMAGICK_VERSION}.tgz"

  tar -xzf /tmp/imagick-${IMAGICK_VERSION}.tgz -C /tmp
  cd /tmp/imagick-${IMAGICK_VERSION}
  phpize
  ./configure --with-imagick=/usr/local/imagick
  make -j"$(nproc)"
  make install

  # å¯ç”¨æ‰©å±•
  echo "extension=imagick.so" >> "${PHP_ROOTDIR}/conf.d/extension.ini"

  # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
  rm -rf /tmp/*
  echo -e "\nâœ… Imagick v${IMAGICK_VERSION} build complete.\n"
}
